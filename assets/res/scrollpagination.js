(function(a,b){var c=true,d=2,e='PAGECACHE_',f=[],g={json:'json',html:'html'};a.fn.currentPage={};a.fn.currentPage.page=0;a.fn.currentPage.html='';a.fn.currentPage.json=[];a.fn.scrollPagination=function(h){var i=this;if(typeof h=="undefined")return false;if(typeof h=="string"){if(h=="flush"){a.localCache.del();return i}else{var o=h;h={'url':o}}};var j=a.extend(a.fn.scrollPagination.defaults,h);var k=j.scrollTarget;if(k==null){k=obj};j.scrollTarget=k;a.fn.currentPage.page=j.data.page||d;var l=a.fn.scrollPagination.getId(a(i),j);j.id=l;var m=a.localCache.get(l);if(!!m&&i.PAGE!=b&&i.HTML!=b&&i.JSON!=b){if(j.dataType==g.html){var o=unescape(i.HTML);a(i).append(o);a.fn.currentPage.html+=o}else{var o=i.JSON;if(j.template){var p='';a.each(o,function(q,r){if(!r||!r.id||in_array(r.id,f))return;f.push(r.id);p+=a.nano(j.template,r)});a(i).append(p)};a.fn.currentPage.json=a.fn.currentPage.json.concat(o)};j.data.page=i.PAGE+1;a.fn.currentPage.page=i.PAGE+1};var n=parseInt(j.expiration);if(!m){a.localCache.set(l,{'PAGE':a.fn.currentPage.page,'HTML':escape(a.fn.currentPage.html),'JSON':a.fn.currentPage.json},n)}else{a.localCache.set(l,m,n)};if(h.loadMore){a(h.loadMore).hide()};return i.each(function(){a.fn.scrollPagination.init(a(i),j)})};a.fn.stopScrollPagination=function(h){return this.each(function(){a(this).attr('scrollPagination','disabled');if(!!h&&!!h.loadMore){a(h.loadMore).hide()}})};var strHashCode=function(h){var i=1,j=0,k;i=0;for(k=h.length-1;k>=0;k--){j=h.charCodeAt(k);i=(i<<6&268435455)+j+(j<<14);j=i&266338304;i=j!=0?i^j>>21:i};return i};function in_array(h,i){var j=typeof h;if(j=='string'||j=='number'){for(var k in i){if(i[k]==h)return true}};return false};a.parseParam=function(h,i){var j="";if(h instanceof String||h instanceof Number||h instanceof Boolean){j+="&"+i+"="+encodeURIComponent(h)}else{a.each(h,function(k){var l=i==null?k:i+(h instanceof Array?"["+k+"]":"."+k);j+='&'+parseParam(this,l)})};return j.substr(1)};a.fn.scrollPagination.loadContent=function(h,i){var j=i.scrollTarget;var k=a(j).scrollTop()+i.offset>=a(document).height()-a(j).height();if(k&&c){c=false;if(i.beforeLoad!=null&&typeof i.beforeLoad=='function'){i.beforeLoad()};if(i.loadMore){a(i.loadMore).show()};var l=a.fn.scrollPagination.getId(a(h),i);i.id=l;var n=a.localCache.get(l);var o=parseInt(i.expiration);if(!n){a.localCache.set(l,{'PAGE':a.fn.currentPage.page,'HTML':escape(a.fn.currentPage.html),'JSON':a.fn.currentPage.json},o)};i.data.page=a.fn.currentPage.page++;if(!i.data||!i.data.page){i.data={'page':i.page}};var p=i.url;if(p.indexOf('?')==-1){p+='?'}else{p+='&'};p+='_r='+Math.random();a(h).children().attr('rel','loaded');a.ajax({type:'POST',url:p,data:i.data,cache:false,dataType:i.dataType==g.html?g.html:g.json,success:function(q){if(i.afterLoad!=null&&typeof i.afterLoad=='function'){i.afterLoad(q,h)};if(i.loadMore){a(i.loadMore).hide()};if(!q||q.length==0){a(h).stopScrollPagination(i);return};var r=[];if(i.dataType==g.json){a.each(q,function(t,u){if(!u||!u.id||in_array(u.id,f))return;f.push(u.id);r.push(u)});if(!r||r.length==0){return}};if(!!i.autoLoad){if(i.dataType==g.html){a(h).append(q)}else if(i.dataType==g.json&&i.template!=null){var t='';a.each(r,function(u,v){t+=a.nano(i.template,v)});a(h).append(t)}};var s=a.localCache.get(l);if(s&&s.PAGE!=b&&s.HTML!=b&&s.JSON!=b){s.PAGE+=1;if(i.dataType==g.json){s.JSON=s.JSON.concat(r)}else{s.HTML+=escape(r)};a.localCache.set(l,s,o)};c=true}})}};a.fn.scrollPagination.init=function(h,i){var j=i.scrollTarget;a(h).attr('scrollPagination','enabled');a(j).scroll(function(k){if(a(h).attr('scrollPagination')=='enabled'){a.fn.scrollPagination.loadContent(h,i)}else{k.stopPropagation()}});a.fn.scrollPagination.loadContent(h,i)};a.fn.scrollPagination.getId=function(h,i){var j,k=window.location,l=i.url+k.pathname+k.search,m=a.cookie('CITY_ID')||'';if(!i||!i.id){j=e+a(h).attr('id')+m+strHashCode(l)}else{j=i.id};console.log('[PAGINATION]ID:'+j);return j};a.fn.scrollPagination.defaults={'url':null,'data':{'page':d},'type':'GET','dataType':g.html,'autoLoad':true,'beforeLoad':null,'scrollTarget':a(window),'offset':500,'loadMore':'#loadMore','template':null,'expiration':30}})($);