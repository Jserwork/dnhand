<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no, minimal-ui">
<meta name="format-detection" content="telephone=no">
<title>绑定锐捷客户端</title>
<link rel="stylesheet" type="text/css" href="/assets/css/lb_min.css">
<link rel="stylesheet" type="text/css" href="/assets/css/zepto.alert.css">
</head>

<body>
<div class="wrap" id="login_page">
  <header class="header">
    <div class="h_t">绑定锐捷客户端</div>
  </header>
  <div class="main">
    <div class="box_insert">
      <div class="form">
        <section id="loginForm" data-switch="#rempwd">
          <div class="form_line">
            <label class="form_label">学号</label>
            <div class="ipt_wrap"><input class="ipt" type="text" name="stuid" id="stuid" placeholder="锐捷客户端登陆学号" value="<%= stuid%>" disabled></div>
          </div>
          <div class="form_line">
            <label class="form_label">密码</label>
            <div class="ipt_wrap"><input class="ipt" type="password" name="pswd" id="pswd" placeholder="锐捷客户端登陆密码"></div>
          </div>
          <div class="form_btns"><button id="commit" class="btn btn_success btn_block btn_lg">绑定</button></div>
        </section>
      </div>
    </div>
  </div>
</div>
<script>
  function onBridgeReady(){
   WeixinJSBridge.call('hideOptionMenu');
   WeixinJSBridge.call('hideToolbar');
  }
  if (typeof WeixinJSBridge == "undefined"){
      if( document.addEventListener ){
          document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
      }else if (document.attachEvent){
          document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
          document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
      }
  }else{
      onBridgeReady();
  }
</script>
<script src="http://cdn.bootcss.com/zepto/1.1.3/zepto.min.js"></script>
<script src="/assets/js/zepto.alert.js"></script>
<script>
  var stuid = "<%= stuid%>",
    pswd,
    openid = "<%= openid%>";
  $("#commit").on("click", function (e) {
    if(!$("#stuid").val()){
      $.dialog({
        content : '请输入学号',
        title: "alert",
        time : 2000
      });
      return
    }else if(!$("#pswd").val()) {
      $.dialog({
        content : '请输入密码!',
        title: "alert",
        time : 2000
      });
      return
    } else {
      $.dialog();
      pswd = $("#pswd").val();
      $.post("/rj/bind", {
          'stuid': stuid,
          'pswd': pswd,
          'openid': openid
        }, function (res) {
            $(".rDialog").remove()
            $(".rDialog-mask").remove()
            if(!!res) {
              if(res.errcode === 0){
                setTimeout(function () {
                  WeixinJSBridge.invoke('closeWindow',{},function(res){});
                }, 3000);
                $.dialog({
                  content : '绑定成功！网票功能开启',
                  title: "alert",
                  time : 3000
                });
              } else if(res.errcode === 2) {
                $("#pswd").val('');
                $("#pswd").focus();
                $.dialog({
                  content : '学号或锐捷登陆密码错误',
                  title: "alert",
                  time : 2000
                });
                return
              } else if(res.errcode === 5) {
                setTimeout(function () {
                  WeixinJSBridge.invoke('closeWindow',{},function(res){});
                }, 3000);
                $.dialog({
                  content : '请在聊天界面回复“绑定”，完成后再来绑定锐捷客户端！',
                  title: "alert",
                  time : 3000
                });
              } else if(res.errcode === 6) {
                setTimeout(function () {
                  WeixinJSBridge.invoke('closeWindow',{},function(res){});
                }, 3000);
                $.dialog({
                  content : '非法访问！学号不一致！',
                  title: "alert",
                  time : 3000
                });
              } else {
                $.dialog({
                  content : '服务器开小差了，请稍候再试',
                  title: "alert",
                  time : 2000
                });
              }
            } else {
              $.dialog({
                  content : '服务器开小差了，请稍候再试',
                  title: "alert",
                  time : 2000
              });
            }
        }, "json");
    }
  });
</script>
</body>
</html>
